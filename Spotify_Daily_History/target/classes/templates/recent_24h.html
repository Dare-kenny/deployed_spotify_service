<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Today — Your Plays</title>
    <style>
        :root{
          --bg:#0e0f12; --card:#14161b; --muted:#9aa3af; --text:#e5e7eb;
          --accent:#6ee7b7; --accent-weak:#19443a; --border:#23262d;
          --row:#171a20; --row-alt:#151821; --row-hover:#1f2430; --chip:#1c1f27;
        }
        *{box-sizing:border-box} html,body{height:100%}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";
             background:radial-gradient(1200px 800px at 80% -100px, rgba(110,231,183,.12), transparent 50%), var(--bg);
             color:var(--text); line-height:1.45;}
        .wrap{max-width:1000px;margin:40px auto;padding:0 16px;}
        .card{background:var(--card);border:1px solid var(--border);border-radius:16px;
              box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden;}
        .card-header{padding:20px 20px 14px;border-bottom:1px solid var(--border);
                     display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
        h1{font-size:clamp(18px,3vw,22px);margin:0;letter-spacing:.2px}
        .muted{color:var(--muted);font-size:.95rem}
        .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);
              border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:.9rem;}
        .chip b{color:var(--text)}
        .tools{display:flex;gap:10px;align-items:center}
        .search{background:#0f1217;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;width:260px;outline:none}
        .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,var(--accent-weak),transparent);
             color:var(--accent);font-weight:600;padding:10px 14px;border-radius:10px;cursor:pointer;transition:transform .06s, box-shadow .06s, border-color .2s}
        .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(110,231,183,.15);border-color:#2e5347}
        .table-wrap{overflow:auto;max-height:70vh}
        table{width:100%;border-collapse:separate;border-spacing:0}
        thead th{position:sticky;top:0;z-index:1;background:linear-gradient(180deg,#171a21,#14161b);
                 border-bottom:1px solid var(--border);color:#d1d5db;font-weight:600;font-size:.9rem;text-align:left;padding:12px 14px;}
        tbody td{padding:14px;border-bottom:1px solid var(--border)}
        tbody tr{background:var(--row)} tbody tr:nth-child(even){background:var(--row-alt)} tbody tr:hover{background:var(--row-hover)}
        .idx{width:48px;color:var(--muted)}
        .track{font-weight:600} .artist{color:var(--muted)}
        .empty{padding:40px;text-align:center;color:var(--muted)}
        .footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;background:linear-gradient(0deg,#111318,transparent)}
        .hint{font-size:.9rem;color:var(--muted)} .brand{color:var(--accent);font-weight:700;letter-spacing:.3px}
        @media (max-width:600px){.search{width:100%}.tools{width:100%}}
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <div class="card-header">
            <div>

                <h1><span class="muted">hello</span> <b th:text="${username}">User</b></h1>
                <div class="muted" th:with="now=${#dates.createNow()}">
            <span class="chip">
              Last updated: <b th:text="${#dates.format(now, 'EEE, dd MMM yyyy • HH:mm')}">—</b>
            </span>
                    <span class="chip" th:if="${tz != null}">
              Time zone: <b th:text="${tz}">Africa/Lagos</b>
            </span>
                    <span class="chip">Window: <b>today (from 12:00 AM)</b></span>
                </div>
            </div>

            <div class="tools">
                <input id="searchBox" class="search" type="search" placeholder="Filter by track or artist…" oninput="filterRows()">
                <button class="btn" onclick="window.location.reload()">Refresh</button>
            </div>
        </div>

        <!-- For when the list is empty -->
        <div class="empty" th:if="${#lists.isEmpty(tracks)}">
            No plays found since 12:00 AM today. Try hitting <span class="brand">Refresh</span> after listening a bit.
        </div>

        <!-- Table (uses tracks from the controller) -->
        <div class="table-wrap" th:if="${!#lists.isEmpty(tracks)}">
            <table id="playsTable">
                <thead>
                <tr>
                    <th class="idx">#</th>
                    <th>Track</th>
                    <th>Artist</th>
                    <th style="text-align:right;">Plays</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="t,iter : ${tracks}">
                    <td class="idx" th:text="${iter.index + 1}">1</td>
                    <td class="track" th:text="${t.trackName}">Track Name</td>
                    <td class="artist" th:text="${t.artistName}">Artist</td>
                    <td style="text-align:right;">
                        <span class="count" th:text="${t.count}">0</span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="footer" th:if="${!#lists.isEmpty(tracks)}">
            <div class="hint">
                <span th:text="'Total plays today: ' + ${#lists.size(tracks)}">Total plays today: —</span>
            </div>
            <div class="hint">
                Powered by <span class="brand">Spotify</span> • From your Recently Played (ordered by last listened)
            </div>
        </div>
    </div>
</div>

<script>
    // Ensure tz= is present; if not, detect browser time zone and reload once with ?tz=...
    (function ensureTz(){
      const params = new URLSearchParams(window.location.search);
      if (!params.has("tz")) {
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (tz) {
          params.set("tz", tz);
          const url = window.location.pathname + "?" + params.toString();
          window.location.replace(url);
        }
      }
    })();

    // Simple client-side filter by track/artist
    function filterRows(){
      const q = document.getElementById('searchBox').value.trim().toLowerCase();
      const rows = document.querySelectorAll('#playsTable tbody tr');
      rows.forEach(r => {
        const track = (r.children[1].textContent || '').toLowerCase();
        const artist = (r.children[2].textContent || '').toLowerCase();
        r.style.display = (track.includes(q) || artist.includes(q)) ? '' : 'none';
      });
    }
</script>
</body>
</html>
